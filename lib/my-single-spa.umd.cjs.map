{"version":3,"file":"my-single-spa.umd.cjs","sources":["../packages/applications/app.helper.js","../packages/navigation/hijackLocation.js","../packages/start.js","../packages/applications/timeouts.js","../packages/lifecycles/helper.js","../packages/lifecycles/load.js","../packages/lifecycles/bootstrap.js","../packages/lifecycles/mount.js","../packages/navigation/invoke.js","../packages/applications/apps.js"],"sourcesContent":["import APP状态 from '../../doc/APP状态.png'\n/**\n * 未加载\n */\nexport const NOT_LOADED = 'NOT_LOADED'\n/**\n * 加载中子应用代码中\n */\nexport const LOAD_RESOURCE_CODE = 'LOAD_RESOURCE_CODE'\n/**\n * 加载成功, 未启动\n */\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED'\n/**\n * 启动中\n */\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING'\n/**\n * 启动成功, 未挂载\n */\nexport const NOT_MOUNTED = 'NOT_MOUNTED'\n/**\n * 挂载中\n */\nexport const MOUNTING = 'MOUNTING'\n/**\n * 挂载成功\n */\nexport const MOUNTED = 'MOUNTED'\n/**\n * 卸载中\n */\nexport const UNMOUNTING = 'UNMOUNTING'\n/**\n * 加载时参数未通过校验或非致命错误\n */\nexport const SKIP_BEACUSE_BROKEN = 'SKIP_BEACUSE_BROKEN'\n/**\n * 加载时遇到致命错误\n */\nexport const LOAD_ERROR = 'LOAD_ERROR'\n/**\n * 更新 service 中\n */\nexport const UPDATING = 'UPDATING'\n\nexport function notSkipped(app) {\n  return app.status !== SKIP_BEACUSE_BROKEN\n}\n\nexport function withoutLoadError(app) {\n  return app.status !== LOAD_ERROR\n}\n\n/**\n * 是否已加载\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isLoaded(app) {\n  return app.status !== NOT_LOADED && app.status !== LOAD_ERROR && app.status !== LOAD_RESOURCE_CODE\n}\n\n/**\n * 未加载\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isntLoaded(app) {\n  return !isLoaded(app)\n}\n\n/**\n * 是否已激活状态\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isActive(app) {\n  return app.status === MOUNTED\n}\n\n/**\n * 是否失活状态\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isntActive(app) {\n  return !isActive(app)\n}\n\n/**\n * 是否可以激活\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function shouldBeActive(app) {\n  try {\n    return app.activityWhen(window.location)\n  } catch (e) {\n    app.status = SKIP_BEACUSE_BROKEN\n    throw e\n  }\n}\n\n/**\n * 是否可以失活\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function shouldntBeActive(app) {\n  try {\n    return !app.activityWhen(window.location)\n  } catch (e) {\n    app.status = SKIP_BEACUSE_BROKEN\n    throw e\n  }\n}\n","import { invoke } from './invoke'\n\n// 拦截的事件名称\nconst HIJACK_EVENTS_NAME = /^(hashchange|popstate)$/i\nconst EVENTS_POOL = {\n  hashchange: [],\n  popstate: []\n}\n\nfunction reroute() {\n  // invoke 用来 load/mount/unmount 满足条件的 app\n  invoke([], arguments)\n}\n// 路由哈希值变化时触发\nwindow.addEventListener('hashchange', reroute)\n// 激活同一文档中不同的历史记录条目时\n// 或者点击后退按钮\n// 或者在 JavaScript 中调用 history.back() 方法时触发\n// 注意, pushState 和 replaceState 不会触发 popstate 事件\n// 所以我们要在下面重写\nwindow.addEventListener('popstate', reroute)\n\n// 拦截所有注册事件(针对 React/Vue 框架), 以确保首先执行此处事件\nconst originalAddEventListener = window.addEventListener\nconst originalRemoveEventListener = window.removeEventListener\n\nwindow.addEventListener = function (eventName, handler) {\n  if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n    const eventList = EVENTS_POOL[eventName]\n    // 首次注册时,保存起来\n    if (eventList.indexOf(handler) === -1) eventList.push(handler)\n  }\n  // 立即执行\n  return originalAddEventListener.apply(this, arguments)\n}\n\nwindow.removeEventListener = function (eventName, handler) {\n  if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n    const eventList = EVENTS_POOL[eventName]\n    if (eventList.indexOf(handler) > -1) EVENTS_POOL[eventName] = eventList.filter(fn => fn !== handler)\n  }\n  return originalRemoveEventListener.apply(this, arguments)\n}\n\n// 拦截 history, 因为 pushState 和 replaceState 不会触发 popstate 事件\nconst originalHistoryPushState = window.history.pushState\nconst originalHistoryReplaceState = window.history.replaceState\nwindow.history.pushState = function (state, title, url) {\n  const result = originalHistoryPushState.apply(this, arguments)\n  // 模拟 popstate 事件\n  reroute(new PopStateEvent('popstate', { state }))\n  return result\n}\nwindow.history.replaceState = function (state, title, url) {\n  const result = originalHistoryReplaceState.apply(this, arguments)\n  // 模拟 popstate 事件\n  reroute(new PopStateEvent('popstate', { state }))\n  return result\n}\n// 子应用的 load/mount/unmount 执行完后,执行此函数,可以保证微前端的逻辑总是第一个执行,然后再执行具体框架的 location 事件\nexport function callCapturedEvents(eventArgs) {\n  if (!eventArgs) return\n  if (Array.isArray(eventArgs)) {\n    eventArgs = eventArgs[0]\n  }\n  const name = eventArgs.type\n  // 是否是拦截的事件名称\n  if (!HIJACK_EVENTS_NAME.test(name)) return\n  // 为什么 this 为 window ?\n  EVENTS_POOL[name].forEach(handler => handler.apply(window, eventArgs))\n}\n","import { invoke } from './navigation/invoke'\n\nlet started = false\n\nexport function start() {\n  if (started) return\n  started = true\n  return invoke()\n}\n\nexport function isStarted() {\n  return started\n}\n","const DEFAULT_TIMEOUTS = {\n  bootstrap: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  },\n  mount: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  },\n  unmount: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  },\n  unload: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  }\n}\n\nexport function ensureAppTimeouts(timeouts = {}) {\n  return {\n    ...DEFAULT_TIMEOUTS,\n    ...timeouts\n  }\n}\n\n/**\n * 卸载超时处理\n * @param {*} promise 上一步 flatten 处理过的生命周期函数\n * @param {*} description 描述\n * @param {*} timeouts 生命周期超时对象\n */\nexport function reasonableTime(promise, description, timeouts) {\n  return new Promise((resolve, reject) => {\n    let finished = false\n\n    promise\n      .then(data => {\n        finished = true\n        resolve(data)\n      })\n      .catch(e => {\n        finished = true\n        reject(e)\n      })\n\n    setTimeout(() => confirmTimeou(), timeouts.millisecond)\n    function confirmTimeou() {\n      if (finished) return\n      const error = `${description} 没有在 ${timeouts.millisecond} 时间内 resolve 或 reject`\n      if (timeouts.rejectWhenTimeout) {\n        reject(new Error(error))\n      } else {\n        console.error(error)\n      }\n    }\n  })\n}\n","import * as mySingleSpa from '../index'\nexport function getProps(app) {\n  return {\n    ...app.customProps,\n    name: app.name,\n    // mountService: mountService.bind(app),\n    mySingleSpa\n  }\n}\n\nexport function isAPromise(promise) {\n  if (promise instanceof Promise) return true\n  return typeof promise === 'object' && typeof promise.then === 'function' && typeof promise.catch === 'function'\n}\n\nexport function validLifeCyclesFn(fn) {\n  if (typeof fn === 'function') return true\n  if (Array.isArray(fn)) {\n    return fn.filter(i => typeof i !== 'function').length === 0\n  }\n  return false\n}\n\n/**\n * 拍平 Promise 数组\n * @param {*} fns\n * @returns\n */\nexport function flattenFnArray(fns = []) {\n  if (!Array.isArray(fns)) fns = [fns]\n  if (fns.length === 0) {\n    fns = [() => Promise.resolve()]\n  }\n\n  return function (props) {\n    return new Promise((resolve, reject) => {\n      // 待验证是否可行\n      // fns.reduce(async (pre, cur, index, arr) => {\n      //   const fn = cur(props)\n      //   if (!isAPromise(fn)) {\n      //     reject(`${fn} 未返回 promise`)\n      //     return\n      //   }\n      //   await fn.then()\n      //   if (index === arr.length - 1) {\n      //     resolve()\n      //   }\n      // }, null)\n\n      waitForPromises(0)\n      function waitForPromises(index) {\n        const fn = fns[index](props)\n        if (!isAPromise(fn)) {\n          reject(`${fn} 未返回 promise`)\n          return\n        }\n        fn.then(() => {\n          if (index === fns.length - 1) {\n            resolve()\n          } else {\n            waitForPromises(++index)\n          }\n        }).catch(e => {\n          reject(e)\n        })\n      }\n    })\n  }\n}\n","import {\n  LOAD_ERROR,\n  LOAD_RESOURCE_CODE,\n  MOUNTED,\n  NOT_BOOTSTRAPPED,\n  NOT_LOADED,\n  NOT_MOUNTED,\n  SKIP_BEACUSE_BROKEN,\n  UNMOUNTING\n} from '../applications/app.helper'\nimport { ensureAppTimeouts, reasonableTime } from '../applications/timeouts'\nimport { flattenFnArray, getProps, isAPromise, validLifeCyclesFn } from './helper'\n\nexport function toUnmountPromise(app) {\n  if (app.status !== MOUNTED) {\n    return Promise.resolve(app)\n  }\n\n  app.status = UNMOUNTING\n\n  function unmountThisApp(serviceUnmountError) {\n    return reasonableTime(app.unmount(getProps(app)), `app: ${app.name} unmounting`, app.timeouts.unmount)\n      .catch(e => {\n        console.log(e)\n        app.status = SKIP_BEACUSE_BROKEN\n      })\n      .then(() => {\n        // APP 卸载完成\n        if (app.status !== SKIP_BEACUSE_BROKEN) {\n          // 由于是 serviceUnmountError 是 Promise.all 返回的, 可能为[]\n          app.status = serviceUnmountError === true ? SKIP_BEACUSE_BROKEN : NOT_MOUNTED\n        }\n        return app\n      })\n  }\n\n  // 优先卸载 app 中的 services (如果存在)\n  const unmountServicePromise = Promise.all(Object.keys(app.services).map(name => app.services[name].unmountSelf()))\n  return unmountServicePromise\n    .catch(e => {\n      console.log(e)\n      return true\n    })\n    .then(unmountThisApp)\n}\n\nexport function toLoadPromise(app) {\n  if (app.status !== NOT_LOADED && app.status !== LOAD_ERROR) {\n    // app 已经被 load\n    return Promise.resolve(app)\n  }\n  // 需要被 load\n  app.status = LOAD_RESOURCE_CODE\n  const loadPromise = app.loadApp(getProps(app))\n  if (!isAPromise(loadPromise)) {\n    console.log('app loadFunction must return a promise')\n    app.status = SKIP_BEACUSE_BROKEN\n    return Promise.resolve(app)\n  }\n\n  return loadPromise\n    .then(module => {\n      const errMsg = []\n      if (typeof module !== 'object') {\n        errMsg.push(`app: ${app.name} 没有导出任何东西`)\n      }\n      ;['bootstrap', 'mount', 'unmount'].forEach(lifecycle => {\n        if (!validLifeCyclesFn(module[lifecycle])) {\n          errMsg.push(`app: ${app.name} 没有导出生命周期: ${lifecycle},或不是一个方法`)\n        }\n      })\n      if (errMsg.length) {\n        console.log(errMsg)\n        app.status = SKIP_BEACUSE_BROKEN\n        return app\n      }\n\n      app.status = NOT_BOOTSTRAPPED\n      app.bootstrap = flattenFnArray(module.bootstrap)\n      app.mount = flattenFnArray(module.mount)\n      app.unmount = flattenFnArray(module.unmount)\n      app.unload = flattenFnArray(module.unload)\n      // 确保有超时处理\n      app.timeouts = ensureAppTimeouts(module.timeouts)\n      return app\n    })\n    .catch(e => {\n      console.log(e)\n      app.status = LOAD_ERROR\n      return app\n    })\n}\n","import { BOOTSTRAPPING, NOT_BOOTSTRAPPED, NOT_MOUNTED, SKIP_BEACUSE_BROKEN } from '../applications/app.helper'\nimport { reasonableTime } from '../applications/timeouts'\nimport { getProps } from './helper'\n\nexport function toBootstrapPromise(app) {\n  if (app.status !== NOT_BOOTSTRAPPED) return Promise.resolve(app)\n\n  app.status = BOOTSTRAPPING\n\n  return reasonableTime(app.bootstrap(getProps(app)), `app: ${app.name} bootstrapping`, app.timeouts.bootstrap)\n    .then(() => {\n      app.status = NOT_MOUNTED\n      return app\n    })\n    .catch(e => {\n      console.log(e)\n      app.status = SKIP_BEACUSE_BROKEN\n      return app\n    })\n}\n","import { MOUNTED, MOUNTING, NOT_MOUNTED, SKIP_BEACUSE_BROKEN } from '../applications/app.helper'\nimport { reasonableTime } from '../applications/timeouts'\nimport { getProps } from './helper'\nimport { toUnmountPromise } from './load'\n\nexport function toMountPromise(app) {\n  if (app.status !== NOT_MOUNTED) return Promise.resolve(app)\n  app.status = MOUNTING\n\n  return reasonableTime(app.mount(getProps(app)), `app: ${app.name} mounting`, app.timeouts.mount)\n    .then(() => {\n      app.status = MOUNTED\n    })\n    .catch(e => {\n      console.log(e)\n      app.status = MOUNTED\n\n      // 挂载失败需要卸载\n      return toUnmountPromise(app)\n        .catch(e => {\n          console.log(e)\n        })\n        .then(() => {\n          app.status = SKIP_BEACUSE_BROKEN\n          return app\n        })\n    })\n}\n","import { callCapturedEvents } from './hijackLocation'\nimport { isStarted } from '../start.js'\nimport { getAppsToLoad, getAppsToMount, getAppsToUnmount, getMountedApps } from '../applications/apps'\nimport { toLoadPromise, toUnmountPromise } from '../lifecycles/load'\nimport { toBootstrapPromise } from '../lifecycles/bootstrap'\nimport { toMountPromise } from '../lifecycles/mount'\n// 加载应用程序正在进行中\nlet loadAppsUnderway = false\nlet pendingPromises = []\n\n/**\n * 注册 / 启动 / 路由切换都会调用\n * @param {*} pendings\n * @param {*} eventArgs\n * @returns\n */\nexport function invoke(pendings = [], eventArgs) {\n  // 加载应用程序正在进行中, 缓存本次, 本次加载完成后再执行\n  if (loadAppsUnderway) {\n    return new Promise((resolve, reject) => {\n      pendingPromises.push({ success: resolve, failure: reject, eventArgs })\n    })\n  }\n  loadAppsUnderway = true\n\n  if (isStarted()) {\n    // 微前端已启动, 进行子应用更改\n    return performAppChange()\n  }\n  // 注册加载子应用\n  return loadApps()\n\n  /**\n   * 启动 / 路由切换都会调用\n   */\n  function performAppChange() {\n    // 需要被卸载的 APP\n    const unmountApps = getAppsToUnmount()\n    const unmountPromises = Promise.all(unmountApps.map(toUnmountPromise))\n\n    // 需要被加载的 APP\n    const loadApps = getAppsToLoad()\n    const loadPromise = loadApps.map(app => {\n      return (\n        toLoadPromise(app)\n          // 启动\n          .then(app => toBootstrapPromise(app))\n          // 卸载\n          .then(() => unmountPromises)\n          // 挂载\n          .then(() => toMountPromise(app))\n      )\n    })\n    // 需要被挂载的 APP\n    const mountApps = getAppsToMount()\n    const mountPromises = mountApps.map(app => {\n      return toBootstrapPromise(app)\n        .then(() => unmountPromises)\n        .then(() => toMountPromise(app))\n    })\n\n    // 执行卸载\n    return unmountPromises.then(\n      () => {\n        // 确保子应用卸载和挂载完后再执行路由事件监听器\n        callCapturedEvents()\n\n        // 执行挂载和卸载\n        const loadAndMountPromises = loadPromise.concat(mountPromises)\n        return Promise.all(loadAndMountPromises).then(finish, e => {\n          pendings.forEach(item => item.reject(e))\n        })\n      },\n      e => {\n        callCapturedEvents()\n        console.log(e)\n        throw e\n      }\n    )\n  }\n\n  function loadApps() {\n    const loadPromises = getAppsToLoad().map(toLoadPromise)\n\n    return Promise.all(loadPromises)\n      .then(() => {\n        // 子应用加载完成\n        callAllCapturedEvents()\n        return finish()\n      })\n      .catch(e => {\n        callAllCapturedEvents()\n        console.log(e)\n      })\n  }\n\n  // 每次循环终止时都会将已拦截的 location 事件进行触发, 这样就可以保证微前端的 location 总是首先执行,\n  // 而 Vue 或 React 的 Router 总是在之后执行\n  function finish() {\n    // 初始化时, 可能为空\n    const resolveValue = getMountedApps()\n\n    // pendings 上一次缓存的 queue\n    // 其实就是调用下面 invoke 方法的 backup\n    if (pendings?.length) {\n      pendings.forEach(item => item.success(resolveValue))\n    }\n    // 循环结束\n    loadAppsUnderway = false\n\n    if (pendingPromises.length) {\n      const backup = pendingPromises\n      pendingPromises = []\n      // 将缓存的 queue 传入 invoke 开启下一次循环\n      return invoke(backup)\n    }\n\n    // 终止循环 返回已挂载的 APP\n    return resolveValue\n  }\n\n  function callAllCapturedEvents() {\n    pendings.length && pendings.filter(item => item.eventArgs).forEach(item => callCapturedEvents(item.eventArgs))\n    eventArgs && callCapturedEvents(eventArgs)\n  }\n}\n","import {\n  isActive,\n  isLoaded,\n  isntActive,\n  isntLoaded,\n  notSkipped,\n  NOT_LOADED,\n  shouldBeActive,\n  shouldntBeActive,\n  withoutLoadError\n} from './app.helper'\nimport { invoke } from '../navigation/invoke'\nconst APPS = []\n\n/**\n * 获取所有子应用名称\n * @return\n */\nexport function getAppNames() {\n  return APPS.map(({ name }) => name)\n}\n\n/**\n * 需要被加载的 APP\n * 1. 没有加载中断\n * 2. 没有加载错误\n * 3. 没有被加载过\n * 4. 满足 app.activityWhen()\n * @return {app[]}\n */\nexport function getAppsToLoad() {\n  return APPS.filter(notSkipped).filter(withoutLoadError).filter(isntLoaded).filter(shouldBeActive)\n}\n\n/**\n * 需要被加载的 app\n * 1. 没有加载中断\n * 2. 加载过的\n * 3. 非激活的\n * 4. 需要被激活的\n * @returns\n */\nexport function getAppsToMount() {\n  return APPS.filter(notSkipped).filter(isLoaded).filter(isntActive).filter(shouldBeActive)\n}\n\n/**\n * 需要被卸载的 APP\n * 1. 没有加载中断\n * 2. 已激活\n * 3. 需要卸载的\n */\nexport function getAppsToUnmount() {\n  return APPS.filter(notSkipped).filter(isActive).filter(shouldntBeActive)\n}\n\n/**\n * 获取已挂载的 APP\n */\nexport function getMountedApps() {\n  return APPS.filter(isActive).map(name => name)\n}\n\n/**\n * 注册子应用\n * @param {string} appName 子应用名称\n * @param {Object|Function<Promise>} applicationOrLoadFunction 子应用配置和异步加载函数\n * @param {Function<Boolean>} activityWhen 判断是否应该被挂载\n * @param {Object} customProps 自定义配置\n * @return {Promise}\n */\nexport function registerApplication(appName, applicationOrLoadFunction, activityWhen, customProps = {}) {\n  if (!appName || typeof appName !== 'string') throw new Error('参数:appName 不能为空字符串')\n  if (getAppNames().includes(appName)) throw new Error(`子应用appName: ${appName} 已注册`)\n  if (!applicationOrLoadFunction) throw new Error('缺少参数: applicationOrLoadFunction')\n  if (typeof activityWhen !== 'function') throw new Error('参数: activityWhen 格式必须为 Function')\n  if (typeof customProps !== 'object' || Array.isArray(customProps))\n    throw new Error('参数:customProps 格式必须为 Object')\n  if (typeof applicationOrLoadFunction !== 'function') {\n    // 转换子应用加载函数\n    applicationOrLoadFunction = () => Promise.resolve(applicationOrLoadFunction)\n  }\n\n  APPS.push({\n    name: appName,\n    loadApp: applicationOrLoadFunction,\n    activityWhen,\n    customProps,\n    status: NOT_LOADED,\n    services: []\n  })\n  return invoke()\n}\n"],"names":["NOT_LOADED","LOAD_RESOURCE_CODE","NOT_BOOTSTRAPPED","BOOTSTRAPPING","NOT_MOUNTED","MOUNTING","MOUNTED","UNMOUNTING","SKIP_BEACUSE_BROKEN","LOAD_ERROR","notSkipped","app","withoutLoadError","isLoaded","isntLoaded","isActive","isntActive","shouldBeActive","shouldntBeActive","HIJACK_EVENTS_NAME","EVENTS_POOL","reroute","invoke","originalAddEventListener","originalRemoveEventListener","eventName","handler","eventList","fn","originalHistoryPushState","originalHistoryReplaceState","state","title","url","result","callCapturedEvents","eventArgs","name","started","start","isStarted","DEFAULT_TIMEOUTS","ensureAppTimeouts","timeouts","reasonableTime","promise","description","resolve","reject","finished","data","e","confirmTimeou","error","getProps","mySingleSpa","isAPromise","validLifeCyclesFn","i","flattenFnArray","fns","props","waitForPromises","index","toUnmountPromise","unmountThisApp","serviceUnmountError","toLoadPromise","loadPromise","module","errMsg","lifecycle","toBootstrapPromise","toMountPromise","loadAppsUnderway","pendingPromises","pendings","performAppChange","loadApps","unmountApps","getAppsToUnmount","unmountPromises","getAppsToLoad","mountPromises","getAppsToMount","loadAndMountPromises","finish","item","loadPromises","callAllCapturedEvents","resolveValue","getMountedApps","backup","APPS","getAppNames","registerApplication","appName","applicationOrLoadFunction","activityWhen","customProps"],"mappings":"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"}