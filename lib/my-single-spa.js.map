{"version":3,"file":"my-single-spa.js","sources":["../packages/applications/app.helper.js","../packages/navigation/hijackLocation.js","../packages/start.js","../packages/applications/timeouts.js","../packages/lifecycles/helper.js","../packages/lifecycles/load.js","../packages/lifecycles/bootstrap.js","../packages/lifecycles/mount.js","../packages/navigation/invoke.js","../packages/applications/apps.js"],"sourcesContent":["import APP状态 from '../../doc/APP状态.png'\n/**\n * 未加载\n */\nexport const NOT_LOADED = 'NOT_LOADED'\n/**\n * 加载中子应用代码中\n */\nexport const LOAD_RESOURCE_CODE = 'LOAD_RESOURCE_CODE'\n/**\n * 加载成功, 未启动\n */\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED'\n/**\n * 启动中\n */\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING'\n/**\n * 启动成功, 未挂载\n */\nexport const NOT_MOUNTED = 'NOT_MOUNTED'\n/**\n * 挂载中\n */\nexport const MOUNTING = 'MOUNTING'\n/**\n * 挂载成功\n */\nexport const MOUNTED = 'MOUNTED'\n/**\n * 卸载中\n */\nexport const UNMOUNTING = 'UNMOUNTING'\n/**\n * 加载时参数未通过校验或非致命错误\n */\nexport const SKIP_BEACUSE_BROKEN = 'SKIP_BEACUSE_BROKEN'\n/**\n * 加载时遇到致命错误\n */\nexport const LOAD_ERROR = 'LOAD_ERROR'\n/**\n * 更新 service 中\n */\nexport const UPDATING = 'UPDATING'\n\nexport function notSkipped(app) {\n  return app.status !== SKIP_BEACUSE_BROKEN\n}\n\nexport function withoutLoadError(app) {\n  return app.status !== LOAD_ERROR\n}\n\n/**\n * 是否已加载\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isLoaded(app) {\n  return app.status !== NOT_LOADED && app.status !== LOAD_ERROR && app.status !== LOAD_RESOURCE_CODE\n}\n\n/**\n * 未加载\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isntLoaded(app) {\n  return !isLoaded(app)\n}\n\n/**\n * 是否已激活状态\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isActive(app) {\n  return app.status === MOUNTED\n}\n\n/**\n * 是否失活状态\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function isntActive(app) {\n  return !isActive(app)\n}\n\n/**\n * 是否可以激活\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function shouldBeActive(app) {\n  try {\n    return app.activityWhen(window.location)\n  } catch (e) {\n    app.status = SKIP_BEACUSE_BROKEN\n    throw e\n  }\n}\n\n/**\n * 是否可以失活\n * @param {*} app\n * @return {Boolean} Boolean\n */\nexport function shouldntBeActive(app) {\n  try {\n    return !app.activityWhen(window.location)\n  } catch (e) {\n    app.status = SKIP_BEACUSE_BROKEN\n    throw e\n  }\n}\n","import { invoke } from './invoke'\n\n// 拦截的事件名称\nconst HIJACK_EVENTS_NAME = /^(hashchange|popstate)$/i\nconst EVENTS_POOL = {\n  hashchange: [],\n  popstate: []\n}\n\nfunction reroute() {\n  // invoke 用来 load/mount/unmount 满足条件的 app\n  invoke([], arguments)\n}\n// 路由哈希值变化时触发\nwindow.addEventListener('hashchange', reroute)\n// 激活同一文档中不同的历史记录条目时\n// 或者点击后退按钮\n// 或者在 JavaScript 中调用 history.back() 方法时触发\n// 注意, pushState 和 replaceState 不会触发 popstate 事件\n// 所以我们要在下面重写\nwindow.addEventListener('popstate', reroute)\n\n// 拦截所有注册事件(针对 React/Vue 框架), 以确保首先执行此处事件\nconst originalAddEventListener = window.addEventListener\nconst originalRemoveEventListener = window.removeEventListener\n\nwindow.addEventListener = function (eventName, handler) {\n  if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n    const eventList = EVENTS_POOL[eventName]\n    // 首次注册时,保存起来\n    if (eventList.indexOf(handler) === -1) eventList.push(handler)\n  }\n  // 立即执行\n  return originalAddEventListener.apply(this, arguments)\n}\n\nwindow.removeEventListener = function (eventName, handler) {\n  if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n    const eventList = EVENTS_POOL[eventName]\n    if (eventList.indexOf(handler) > -1) EVENTS_POOL[eventName] = eventList.filter(fn => fn !== handler)\n  }\n  return originalRemoveEventListener.apply(this, arguments)\n}\n\n// 拦截 history, 因为 pushState 和 replaceState 不会触发 popstate 事件\nconst originalHistoryPushState = window.history.pushState\nconst originalHistoryReplaceState = window.history.replaceState\nwindow.history.pushState = function (state, title, url) {\n  const result = originalHistoryPushState.apply(this, arguments)\n  // 模拟 popstate 事件\n  reroute(new PopStateEvent('popstate', { state }))\n  return result\n}\nwindow.history.replaceState = function (state, title, url) {\n  const result = originalHistoryReplaceState.apply(this, arguments)\n  // 模拟 popstate 事件\n  reroute(new PopStateEvent('popstate', { state }))\n  return result\n}\n// 子应用的 load/mount/unmount 执行完后,执行此函数,可以保证微前端的逻辑总是第一个执行,然后再执行具体框架的 location 事件\nexport function callCapturedEvents(eventArgs) {\n  if (!eventArgs) return\n  if (Array.isArray(eventArgs)) {\n    eventArgs = eventArgs[0]\n  }\n  const name = eventArgs.type\n  // 是否是拦截的事件名称\n  if (!HIJACK_EVENTS_NAME.test(name)) return\n  // 为什么 this 为 window ?\n  EVENTS_POOL[name].forEach(handler => handler.apply(window, eventArgs))\n}\n","import { invoke } from './navigation/invoke'\n\nlet started = false\n\nexport function start() {\n  if (started) return\n  started = true\n  return invoke()\n}\n\nexport function isStarted() {\n  return started\n}\n","const DEFAULT_TIMEOUTS = {\n  bootstrap: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  },\n  mount: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  },\n  unmount: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  },\n  unload: {\n    // 超时(毫秒)\n    millisecond: 3000,\n    // 当超时，是否\n    rejectWhenTimeout: false\n  }\n}\n\nexport function ensureAppTimeouts(timeouts = {}) {\n  return {\n    ...DEFAULT_TIMEOUTS,\n    ...timeouts\n  }\n}\n\n/**\n * 卸载超时处理\n * @param {*} promise 上一步 flatten 处理过的生命周期函数\n * @param {*} description 描述\n * @param {*} timeouts 生命周期超时对象\n */\nexport function reasonableTime(promise, description, timeouts) {\n  return new Promise((resolve, reject) => {\n    let finished = false\n\n    promise\n      .then(data => {\n        finished = true\n        resolve(data)\n      })\n      .catch(e => {\n        finished = true\n        reject(e)\n      })\n\n    setTimeout(() => confirmTimeou(), timeouts.millisecond)\n    function confirmTimeou() {\n      if (finished) return\n      const error = `${description} 没有在 ${timeouts.millisecond} 时间内 resolve 或 reject`\n      if (timeouts.rejectWhenTimeout) {\n        reject(new Error(error))\n      } else {\n        console.error(error)\n      }\n    }\n  })\n}\n","import * as mySingleSpa from '../index'\nexport function getProps(app) {\n  return {\n    ...app.customProps,\n    name: app.name,\n    // mountService: mountService.bind(app),\n    mySingleSpa\n  }\n}\n\nexport function isAPromise(promise) {\n  if (promise instanceof Promise) return true\n  return typeof promise === 'object' && typeof promise.then === 'function' && typeof promise.catch === 'function'\n}\n\nexport function validLifeCyclesFn(fn) {\n  if (typeof fn === 'function') return true\n  if (Array.isArray(fn)) {\n    return fn.filter(i => typeof i !== 'function').length === 0\n  }\n  return false\n}\n\n/**\n * 拍平 Promise 数组\n * @param {*} fns\n * @returns\n */\nexport function flattenFnArray(fns = []) {\n  if (!Array.isArray(fns)) fns = [fns]\n  if (fns.length === 0) {\n    fns = [() => Promise.resolve()]\n  }\n\n  return function (props) {\n    return new Promise((resolve, reject) => {\n      // 待验证是否可行\n      // fns.reduce(async (pre, cur, index, arr) => {\n      //   const fn = cur(props)\n      //   if (!isAPromise(fn)) {\n      //     reject(`${fn} 未返回 promise`)\n      //     return\n      //   }\n      //   await fn.then()\n      //   if (index === arr.length - 1) {\n      //     resolve()\n      //   }\n      // }, null)\n\n      waitForPromises(0)\n      function waitForPromises(index) {\n        const fn = fns[index](props)\n        if (!isAPromise(fn)) {\n          reject(`${fn} 未返回 promise`)\n          return\n        }\n        fn.then(() => {\n          if (index === fns.length - 1) {\n            resolve()\n          } else {\n            waitForPromises(++index)\n          }\n        }).catch(e => {\n          reject(e)\n        })\n      }\n    })\n  }\n}\n","import {\n  LOAD_ERROR,\n  LOAD_RESOURCE_CODE,\n  MOUNTED,\n  NOT_BOOTSTRAPPED,\n  NOT_LOADED,\n  NOT_MOUNTED,\n  SKIP_BEACUSE_BROKEN,\n  UNMOUNTING\n} from '../applications/app.helper'\nimport { ensureAppTimeouts, reasonableTime } from '../applications/timeouts'\nimport { flattenFnArray, getProps, isAPromise, validLifeCyclesFn } from './helper'\n\nexport function toUnmountPromise(app) {\n  if (app.status !== MOUNTED) {\n    return Promise.resolve(app)\n  }\n\n  app.status = UNMOUNTING\n\n  function unmountThisApp(serviceUnmountError) {\n    return reasonableTime(app.unmount(getProps(app)), `app: ${app.name} unmounting`, app.timeouts.unmount)\n      .catch(e => {\n        console.log(e)\n        app.status = SKIP_BEACUSE_BROKEN\n      })\n      .then(() => {\n        // APP 卸载完成\n        if (app.status !== SKIP_BEACUSE_BROKEN) {\n          // 由于是 serviceUnmountError 是 Promise.all 返回的, 可能为[]\n          app.status = serviceUnmountError === true ? SKIP_BEACUSE_BROKEN : NOT_MOUNTED\n        }\n        return app\n      })\n  }\n\n  // 优先卸载 app 中的 services (如果存在)\n  const unmountServicePromise = Promise.all(Object.keys(app.services).map(name => app.services[name].unmountSelf()))\n  return unmountServicePromise\n    .catch(e => {\n      console.log(e)\n      return true\n    })\n    .then(unmountThisApp)\n}\n\nexport function toLoadPromise(app) {\n  if (app.status !== NOT_LOADED && app.status !== LOAD_ERROR) {\n    // app 已经被 load\n    return Promise.resolve(app)\n  }\n  // 需要被 load\n  app.status = LOAD_RESOURCE_CODE\n  const loadPromise = app.loadApp(getProps(app))\n  if (!isAPromise(loadPromise)) {\n    console.log('app loadFunction must return a promise')\n    app.status = SKIP_BEACUSE_BROKEN\n    return Promise.resolve(app)\n  }\n\n  return loadPromise\n    .then(module => {\n      const errMsg = []\n      if (typeof module !== 'object') {\n        errMsg.push(`app: ${app.name} 没有导出任何东西`)\n      }\n      ;['bootstrap', 'mount', 'unmount'].forEach(lifecycle => {\n        if (!validLifeCyclesFn(module[lifecycle])) {\n          errMsg.push(`app: ${app.name} 没有导出生命周期: ${lifecycle},或不是一个方法`)\n        }\n      })\n      if (errMsg.length) {\n        console.log(errMsg)\n        app.status = SKIP_BEACUSE_BROKEN\n        return app\n      }\n\n      app.status = NOT_BOOTSTRAPPED\n      app.bootstrap = flattenFnArray(module.bootstrap)\n      app.mount = flattenFnArray(module.mount)\n      app.unmount = flattenFnArray(module.unmount)\n      app.unload = flattenFnArray(module.unload)\n      // 确保有超时处理\n      app.timeouts = ensureAppTimeouts(module.timeouts)\n      return app\n    })\n    .catch(e => {\n      console.log(e)\n      app.status = LOAD_ERROR\n      return app\n    })\n}\n","import { BOOTSTRAPPING, NOT_BOOTSTRAPPED, NOT_MOUNTED, SKIP_BEACUSE_BROKEN } from '../applications/app.helper'\nimport { reasonableTime } from '../applications/timeouts'\nimport { getProps } from './helper'\n\nexport function toBootstrapPromise(app) {\n  if (app.status !== NOT_BOOTSTRAPPED) return Promise.resolve(app)\n\n  app.status = BOOTSTRAPPING\n\n  return reasonableTime(app.bootstrap(getProps(app)), `app: ${app.name} bootstrapping`, app.timeouts.bootstrap)\n    .then(() => {\n      app.status = NOT_MOUNTED\n      return app\n    })\n    .catch(e => {\n      console.log(e)\n      app.status = SKIP_BEACUSE_BROKEN\n      return app\n    })\n}\n","import { MOUNTED, MOUNTING, NOT_MOUNTED, SKIP_BEACUSE_BROKEN } from '../applications/app.helper'\nimport { reasonableTime } from '../applications/timeouts'\nimport { getProps } from './helper'\nimport { toUnmountPromise } from './load'\n\nexport function toMountPromise(app) {\n  if (app.status !== NOT_MOUNTED) return Promise.resolve(app)\n  app.status = MOUNTING\n\n  return reasonableTime(app.mount(getProps(app)), `app: ${app.name} mounting`, app.timeouts.mount)\n    .then(() => {\n      app.status = MOUNTED\n    })\n    .catch(e => {\n      console.log(e)\n      app.status = MOUNTED\n\n      // 挂载失败需要卸载\n      return toUnmountPromise(app)\n        .catch(e => {\n          console.log(e)\n        })\n        .then(() => {\n          app.status = SKIP_BEACUSE_BROKEN\n          return app\n        })\n    })\n}\n","import { callCapturedEvents } from './hijackLocation'\nimport { isStarted } from '../start.js'\nimport { getAppsToLoad, getAppsToMount, getAppsToUnmount, getMountedApps } from '../applications/apps'\nimport { toLoadPromise, toUnmountPromise } from '../lifecycles/load'\nimport { toBootstrapPromise } from '../lifecycles/bootstrap'\nimport { toMountPromise } from '../lifecycles/mount'\n// 加载应用程序正在进行中\nlet loadAppsUnderway = false\nlet pendingPromises = []\n\n/**\n * 注册 / 启动 / 路由切换都会调用\n * @param {*} pendings\n * @param {*} eventArgs\n * @returns\n */\nexport function invoke(pendings = [], eventArgs) {\n  // 加载应用程序正在进行中, 缓存本次, 本次加载完成后再执行\n  if (loadAppsUnderway) {\n    return new Promise((resolve, reject) => {\n      pendingPromises.push({ success: resolve, failure: reject, eventArgs })\n    })\n  }\n  loadAppsUnderway = true\n\n  if (isStarted()) {\n    // 微前端已启动, 进行子应用更改\n    return performAppChange()\n  }\n  // 注册加载子应用\n  return loadApps()\n\n  /**\n   * 启动 / 路由切换都会调用\n   */\n  function performAppChange() {\n    // 需要被卸载的 APP\n    const unmountApps = getAppsToUnmount()\n    const unmountPromises = Promise.all(unmountApps.map(toUnmountPromise))\n\n    // 需要被加载的 APP\n    const loadApps = getAppsToLoad()\n    const loadPromise = loadApps.map(app => {\n      return (\n        toLoadPromise(app)\n          // 启动\n          .then(app => toBootstrapPromise(app))\n          // 卸载\n          .then(() => unmountPromises)\n          // 挂载\n          .then(() => toMountPromise(app))\n      )\n    })\n    // 需要被挂载的 APP\n    const mountApps = getAppsToMount()\n    const mountPromises = mountApps.map(app => {\n      return toBootstrapPromise(app)\n        .then(() => unmountPromises)\n        .then(() => toMountPromise(app))\n    })\n\n    // 执行卸载\n    return unmountPromises.then(\n      () => {\n        // 确保子应用卸载和挂载完后再执行路由事件监听器\n        callCapturedEvents()\n\n        // 执行挂载和卸载\n        const loadAndMountPromises = loadPromise.concat(mountPromises)\n        return Promise.all(loadAndMountPromises).then(finish, e => {\n          pendings.forEach(item => item.reject(e))\n        })\n      },\n      e => {\n        callCapturedEvents()\n        console.log(e)\n        throw e\n      }\n    )\n  }\n\n  function loadApps() {\n    const loadPromises = getAppsToLoad().map(toLoadPromise)\n\n    return Promise.all(loadPromises)\n      .then(() => {\n        // 子应用加载完成\n        callAllCapturedEvents()\n        return finish()\n      })\n      .catch(e => {\n        callAllCapturedEvents()\n        console.log(e)\n      })\n  }\n\n  // 每次循环终止时都会将已拦截的 location 事件进行触发, 这样就可以保证微前端的 location 总是首先执行,\n  // 而 Vue 或 React 的 Router 总是在之后执行\n  function finish() {\n    // 初始化时, 可能为空\n    const resolveValue = getMountedApps()\n\n    // pendings 上一次缓存的 queue\n    // 其实就是调用下面 invoke 方法的 backup\n    if (pendings?.length) {\n      pendings.forEach(item => item.success(resolveValue))\n    }\n    // 循环结束\n    loadAppsUnderway = false\n\n    if (pendingPromises.length) {\n      const backup = pendingPromises\n      pendingPromises = []\n      // 将缓存的 queue 传入 invoke 开启下一次循环\n      return invoke(backup)\n    }\n\n    // 终止循环 返回已挂载的 APP\n    return resolveValue\n  }\n\n  function callAllCapturedEvents() {\n    pendings.length && pendings.filter(item => item.eventArgs).forEach(item => callCapturedEvents(item.eventArgs))\n    eventArgs && callCapturedEvents(eventArgs)\n  }\n}\n","import {\n  isActive,\n  isLoaded,\n  isntActive,\n  isntLoaded,\n  notSkipped,\n  NOT_LOADED,\n  shouldBeActive,\n  shouldntBeActive,\n  withoutLoadError\n} from './app.helper'\nimport { invoke } from '../navigation/invoke'\nconst APPS = []\n\n/**\n * 获取所有子应用名称\n * @return\n */\nexport function getAppNames() {\n  return APPS.map(({ name }) => name)\n}\n\n/**\n * 需要被加载的 APP\n * 1. 没有加载中断\n * 2. 没有加载错误\n * 3. 没有被加载过\n * 4. 满足 app.activityWhen()\n * @return {app[]}\n */\nexport function getAppsToLoad() {\n  return APPS.filter(notSkipped).filter(withoutLoadError).filter(isntLoaded).filter(shouldBeActive)\n}\n\n/**\n * 需要被加载的 app\n * 1. 没有加载中断\n * 2. 加载过的\n * 3. 非激活的\n * 4. 需要被激活的\n * @returns\n */\nexport function getAppsToMount() {\n  return APPS.filter(notSkipped).filter(isLoaded).filter(isntActive).filter(shouldBeActive)\n}\n\n/**\n * 需要被卸载的 APP\n * 1. 没有加载中断\n * 2. 已激活\n * 3. 需要卸载的\n */\nexport function getAppsToUnmount() {\n  return APPS.filter(notSkipped).filter(isActive).filter(shouldntBeActive)\n}\n\n/**\n * 获取已挂载的 APP\n */\nexport function getMountedApps() {\n  return APPS.filter(isActive).map(name => name)\n}\n\n/**\n * 注册子应用\n * @param {string} appName 子应用名称\n * @param {Object|Function<Promise>} applicationOrLoadFunction 子应用配置和异步加载函数\n * @param {Function<Boolean>} activityWhen 判断是否应该被挂载\n * @param {Object} customProps 自定义配置\n * @return {Promise}\n */\nexport function registerApplication(appName, applicationOrLoadFunction, activityWhen, customProps = {}) {\n  if (!appName || typeof appName !== 'string') throw new Error('参数:appName 不能为空字符串')\n  if (getAppNames().includes(appName)) throw new Error(`子应用appName: ${appName} 已注册`)\n  if (!applicationOrLoadFunction) throw new Error('缺少参数: applicationOrLoadFunction')\n  if (typeof activityWhen !== 'function') throw new Error('参数: activityWhen 格式必须为 Function')\n  if (typeof customProps !== 'object' || Array.isArray(customProps))\n    throw new Error('参数:customProps 格式必须为 Object')\n  if (typeof applicationOrLoadFunction !== 'function') {\n    // 转换子应用加载函数\n    applicationOrLoadFunction = () => Promise.resolve(applicationOrLoadFunction)\n  }\n\n  APPS.push({\n    name: appName,\n    loadApp: applicationOrLoadFunction,\n    activityWhen,\n    customProps,\n    status: NOT_LOADED,\n    services: []\n  })\n  return invoke()\n}\n"],"names":["NOT_LOADED","LOAD_RESOURCE_CODE","NOT_BOOTSTRAPPED","BOOTSTRAPPING","NOT_MOUNTED","MOUNTING","MOUNTED","UNMOUNTING","SKIP_BEACUSE_BROKEN","LOAD_ERROR","notSkipped","app","withoutLoadError","isLoaded","isntLoaded","isActive","isntActive","shouldBeActive","shouldntBeActive","HIJACK_EVENTS_NAME","EVENTS_POOL","reroute","invoke","originalAddEventListener","originalRemoveEventListener","eventName","handler","eventList","fn","originalHistoryPushState","originalHistoryReplaceState","state","title","url","result","callCapturedEvents","eventArgs","name","started","start","isStarted","DEFAULT_TIMEOUTS","ensureAppTimeouts","timeouts","reasonableTime","promise","description","resolve","reject","finished","data","e","confirmTimeou","error","getProps","mySingleSpa","isAPromise","validLifeCyclesFn","i","flattenFnArray","fns","props","waitForPromises","index","toUnmountPromise","unmountThisApp","serviceUnmountError","toLoadPromise","loadPromise","module","errMsg","lifecycle","toBootstrapPromise","toMountPromise","loadAppsUnderway","pendingPromises","pendings","performAppChange","loadApps","unmountApps","getAppsToUnmount","unmountPromises","getAppsToLoad","mountPromises","getAppsToMount","loadAndMountPromises","finish","item","loadPromises","callAllCapturedEvents","resolveValue","getMountedApps","backup","APPS","getAppNames","registerApplication","appName","applicationOrLoadFunction","activityWhen","customProps"],"mappings":"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"}